# Emotion Summary (ES) - 执行命令清单

## 📋 按顺序执行以下命令

### ✅ 第一步：安装依赖（必需）

```bash
# 核心依赖（必需）
pip install torch transformers datasets evaluate rouge-score nltk accelerate scikit-learn tqdm

# 可选依赖
pip install matplotlib seaborn huggingface-hub pyyaml psutil
```

**或者使用requirements文件：**

```bash
pip install -r "Emotion Summary (ES)/requirements_es.txt"
```

**下载NLTK数据：**

```bash
python -c "import nltk; nltk.download('punkt'); nltk.download('stopwords')"
```

---

### ✅ 第二步：验证安装（推荐）

创建一个测试脚本 `test_install.py`:

```python
import torch
import transformers
import datasets
import evaluate

print("✓ PyTorch:", torch.__version__)
print("✓ CUDA available:", torch.cuda.is_available())
print("✓ Transformers:", transformers.__version__)
print("✓ Datasets:", datasets.__version__)
print("✓ 所有依赖安装成功！")
```

运行：
```bash
python test_install.py
```

---

### ✅ 第三步：准备数据

```bash
cd "Emotion Summary (ES)/scripts"
python prepare_datasets.py
```

**注意事项：**
- 首次运行需要从Hugging Face下载数据
- 如果数据集名称不正确，会创建示例数据
- 确保网络连接正常

**数据集配置位置：**
- 文件：`config/config.py`
- 变量：`DATASET_NAME` 和 `DATASET_SUBSET`

---

### ✅ 第四步：训练模型

```bash
python train.py
```

**训练参数（在 config/config.py 中调整）：**
- 批次大小：`BATCH_SIZE = 4`
- 训练轮数：`NUM_EPOCHS = 3`
- 学习率：`LEARNING_RATE = 5e-5`

**如果显存不足：**
```python
# 修改 config/config.py
BATCH_SIZE = 2
GRADIENT_ACCUMULATION_STEPS = 8
FP16 = True
```

**训练时间估计：**
- 小数据集（<1000样本）：1-2小时
- 中等数据集（1000-10000样本）：3-8小时

---

### ✅ 第五步：生成总结（推理）

```bash
python inference.py
```

**输出文件：**
- `../submission/submission.jsonl`

**格式：**
```json
{
    "id": 0,
    "generated_summary": {
        "causes": "...",
        "symptoms": "...",
        "treatment_process": "...",
        "illness_characteristics": "...",
        "treatment_effects": "..."
    }
}
```

---

### ✅ 第六步：评估结果

```bash
python evaluate.py
```

**评估指标：**
- ROUGE-1/2/L
- BLEU

**预期分数（参考）：**
- ROUGE-1: 0.35-0.45
- ROUGE-2: 0.15-0.25
- ROUGE-L: 0.30-0.40
- BLEU: 0.20-0.35

---

## 🔧 常用调试命令

### 测试模型加载

```bash
cd "Emotion Summary (ES)/scripts"
python model.py
```

### 查看配置

```bash
python -c "import sys; sys.path.append('Emotion Summary (ES)'); from config.config import print_config; print_config()"
```

### 查看数据样本

```python
import json
with open('Emotion Summary (ES)/data/train.jsonl', 'r', encoding='utf-8') as f:
    sample = json.loads(f.readline())
    print(json.dumps(sample, indent=2, ensure_ascii=False))
```

---

## 🚨 常见问题快速解决

### 问题1: CUDA out of memory

```python
# 在 config/config.py 中修改
BATCH_SIZE = 1
GRADIENT_ACCUMULATION_STEPS = 16
USE_GRADIENT_CHECKPOINTING = True
```

### 问题2: 数据集下载失败

1. 检查网络连接
2. 确认数据集名称
3. 使用示例数据测试流程

### 问题3: 模型下载慢

设置Hugging Face镜像：
```bash
export HF_ENDPOINT=https://hf-mirror.com
```

Windows PowerShell:
```powershell
$env:HF_ENDPOINT="https://hf-mirror.com"
```

### 问题4: 找不到模块

```bash
# 确保在正确的目录
cd "Emotion Summary (ES)/scripts"

# 或添加项目路径
$env:PYTHONPATH="C:\Users\xsz20\project(self)\LongEmotion\Emotion Summary (ES)"
```

---

## 📊 完整流程（一键执行）

**注意：仅在所有依赖安装完成后使用**

```bash
cd "Emotion Summary (ES)/scripts"
python prepare_datasets.py
python train.py
python inference.py
python evaluate.py
```

---

## 🎯 快速测试（使用示例数据）

如果只想测试流程，不进行完整训练：

```python
# 在 config/config.py 中修改
DEBUG_MODE = True
DEBUG_SAMPLES = 10
NUM_EPOCHS = 1
```

然后运行：
```bash
cd "Emotion Summary (ES)/scripts"
python prepare_datasets.py
python train.py
python inference.py
```

---

## 📁 输出文件位置

- **数据集**: `Emotion Summary (ES)/data/`
  - `train.jsonl`
  - `validation.jsonl`
  - `test.jsonl`

- **模型**: `Emotion Summary (ES)/model/best_model/`
  - `pytorch_model.bin`
  - `config.json`
  - `tokenizer.json`
  - ...

- **提交文件**: `Emotion Summary (ES)/submission/`
  - `submission.jsonl`

- **日志**: `Emotion Summary (ES)/logs/`

---

## ✅ 检查清单

执行前检查：
- [ ] 虚拟环境已激活
- [ ] 所有依赖已安装
- [ ] CUDA可用（如使用GPU）
- [ ] 足够的磁盘空间（>10GB）

执行后检查：
- [ ] 数据文件已生成
- [ ] 模型文件已保存
- [ ] 提交文件已创建
- [ ] 评估分数合理

---

## 🔍 监控训练进度

训练过程中会显示：
- 当前epoch
- 训练损失
- 验证损失
- 进度条

**最佳实践：**
- 观察验证损失是否下降
- 如果验证损失不再下降，可以提前停止
- 保存最佳模型

---

## 📞 获取帮助

- **README.md** - 完整文档
- **QUICK_START.md** - 快速开始
- **INSTALLATION.md** - 安装指南
- **PROJECT_STATUS.md** - 项目状态
- **工作总结报告.md** - 详细报告

---

**祝训练顺利！🚀**

