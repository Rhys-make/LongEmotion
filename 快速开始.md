# LongEmotion 快速开始指南

## 一、环境准备（5 分钟）

### Windows

```powershell
# 1. 创建虚拟环境
python -m venv venv
.\venv\Scripts\activate

# 2. 安装依赖
pip install -r requirements.txt

# 3. 如果网络较慢，使用国内镜像
pip install -r requirements.txt -i https://pypi.tuna.tsinghua.edu.cn/simple
```

### Linux/Mac

```bash
# 1. 创建虚拟环境
python -m venv venv
source venv/bin/activate

# 2. 安装依赖
pip install -r requirements.txt
```

## 二、下载数据（10 分钟）

```bash
# 下载所有任务的数据集
python scripts/download_dataset.py

# 如果网络问题，使用镜像
set HF_ENDPOINT=https://hf-mirror.com  # Windows
export HF_ENDPOINT=https://hf-mirror.com  # Linux/Mac
python scripts/download_dataset.py
```

**检查数据是否下载成功：**

```bash
python scripts/download_dataset.py --verify
```

## 三、训练模型（取决于 GPU）

### 快速测试（10 分钟）

仅训练分类任务，使用小批量和少量轮数：

```bash
python scripts/train_all.py --tasks classification --num_epochs 1 --batch_size 8
```

### 完整训练（数小时）

训练所有任务：

```bash
# CPU 训练（慢）
python scripts/train_all.py --device cpu --batch_size 4

# GPU 训练（快）
python scripts/train_all.py --device cuda --batch_size 16
```

### 分别训练各任务

```bash
# 1. 分类任务（最快）
python scripts/train_all.py --tasks classification

# 2. 检测任务
python scripts/train_all.py --tasks detection

# 3. 摘要任务
python scripts/train_all.py --tasks summary

# 4. 问答任务
python scripts/train_all.py --tasks qa

# 5. 对话任务（需要大显存，建议跳过或使用小模型）
# python scripts/train_all.py --tasks conversation --batch_size 2
```

## 四、生成推理结果（10 分钟）

```bash
# 推理所有任务
python scripts/inference_all.py

# 推理特定任务
python scripts/inference_all.py --tasks classification detection
```

**结果文件位于 `results/` 目录：**

- `classification_test.jsonl`
- `detection_test.jsonl`
- `conversation_test.jsonl`
- `summary_test.jsonl`
- `qa_test.jsonl`

## 五、启动 API 服务（1 分钟）

```bash
cd api
python main.py
```

**访问：**

- API 服务: http://localhost:8000
- API 文档: http://localhost:8000/docs

**测试 API：**

```bash
# Windows PowerShell
Invoke-WebRequest -Uri "http://localhost:8000/classify" -Method POST -ContentType "application/json" -Body '{"text":"今天真开心！"}'

# Linux/Mac
curl -X POST "http://localhost:8000/classify" -H "Content-Type: application/json" -d '{"text":"今天真开心！"}'
```

或者使用 Python：

```python
import requests

response = requests.post(
    "http://localhost:8000/classify",
    json={"text": "今天真开心！"}
)
print(response.json())
```

## 六、常见问题

### 1. 网络问题（下载模型/数据集失败）

```bash
# 设置 Hugging Face 镜像
set HF_ENDPOINT=https://hf-mirror.com  # Windows
export HF_ENDPOINT=https://hf-mirror.com  # Linux/Mac
```

### 2. 显存不足（CUDA out of memory）

**方案 1: 减小批量大小**
```bash
python scripts/train_all.py --batch_size 4
```

**方案 2: 使用 CPU**
```bash
python scripts/train_all.py --device cpu
```

**方案 3: 只训练小模型**
```bash
# 跳过对话和摘要任务
python scripts/train_all.py --tasks classification detection qa
```

### 3. 模块导入错误

确保在项目根目录运行脚本：

```bash
# 查看当前目录
pwd  # Linux/Mac
cd   # Windows

# 应该包含这些文件夹
ls  # 应该看到: models/ utils/ scripts/ api/
```

### 4. 找不到数据集

确保数据已下载：

```bash
python scripts/download_dataset.py --verify
```

## 七、项目文件结构

```
LongEmotion/
├── models/           ← 模型定义
├── utils/            ← 工具函数
├── scripts/          ← 训练和推理脚本
├── api/              ← FastAPI 服务
├── data/             ← 数据集（下载后生成）
├── checkpoints/      ← 训练的模型（训练后生成）
├── results/          ← 推理结果（推理后生成）
├── config.py         ← 配置文件
├── run_example.py    ← 示例代码
└── requirements.txt  ← 依赖列表
```

## 八、完整流程（一条龙）

```bash
# 1. 安装依赖
pip install -r requirements.txt

# 2. 下载数据
python scripts/download_dataset.py

# 3. 训练模型（选择一个）
python scripts/train_all.py --tasks classification  # 快速测试
# python scripts/train_all.py  # 完整训练

# 4. 推理
python scripts/inference_all.py

# 5. 启动服务
cd api
python main.py
```

## 九、验证结果

### 检查训练结果

```bash
# 查看模型文件
ls checkpoints/classification/best_model/  # Linux/Mac
dir checkpoints\classification\best_model\  # Windows

# 应该包含: config.json, pytorch_model.bin 等
```

### 检查推理结果

```bash
# 查看结果文件
head results/classification_test.jsonl  # Linux/Mac
type results\classification_test.jsonl | more  # Windows

# 应该是 JSONL 格式的预测结果
```

### 测试 API

打开浏览器访问：http://localhost:8000/docs

可以在页面上直接测试各个 API 接口。

## 十、提交到比赛

### 1. 准备提交文件

```bash
# 推理结果（5个文件）
results/classification_test.jsonl
results/detection_test.jsonl
results/conversation_test.jsonl
results/summary_test.jsonl
results/qa_test.jsonl
```

### 2. 上传模型到 Hugging Face

```python
from huggingface_hub import HfApi

api = HfApi()

# 上传分类模型
api.upload_folder(
    folder_path="./checkpoints/classification/best_model",
    repo_id="your-username/longemotion-classification",
    repo_type="model"
)
```

### 3. 上传代码到 GitHub

```bash
git init
git add .
git commit -m "LongEmotion 完整方案"
git remote add origin your-repo-url
git push -u origin main
```

## 需要帮助？

- 查看详细文档: `README.md`
- 运行示例代码: `python run_example.py`
- 查看配置选项: `python scripts/train_all.py --help`

**祝你比赛顺利！** 🎉

